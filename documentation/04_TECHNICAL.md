# Технические детали MCP сервера

## Алгоритм поиска

Поиск выполняется по принципу нечеткого соответствия с ранжированием:

1. **Точное совпадение** (100 баллов) - имя полностью совпадает с запросом
2. **Префиксное совпадение** (80 баллов) - имя начинается с запроса  
3. **Частичное совпадение** (60 баллов) - имя содержит запрос
4. **Совпадение в сигнатуре** (40 баллов) - запрос найден в сигнатуре
5. **Совпадение в описании** (20 баллов) - запрос найден в описании
6. **Fuzzy matching** (0-50 баллов) - на основе расстояния Левенштейна

### Детали реализации поиска

- **Индексация**: При запуске сервера все элементы API платформы индексируются для быстрого поиска
- **Кэширование**: Результаты поиска кэшируются для повышения производительности
- **Ранжирование**: Результаты сортируются по релевантности на основе балльной системы
- **Фильтрация**: Поддерживается фильтрация по типу элемента (метод, свойство, тип)

## Формат ответов

Сервер возвращает результаты в формате Markdown с адаптивным форматированием:

- **1 результат** - детальное описание с сигнатурой и параметрами
- **2-5 результатов** - компактное описание каждого с разделителями  
- **>5 результатов** - табличное представление топ-5 + детали первого

### Пример ответа

```markdown
# Результаты поиска: "найти файл" (3 найдено)

## НайтиФайлы
```bsl
НайтиФайлы(Путь: Строка, Маска: Строка): Массив
```
*Глобальный метод* • **Методы**

Находит файлы в указанном каталоге по маске поиска.

---

## НайтиФайлыВПодкаталогах
```bsl
НайтиФайлыВПодкаталогах(Путь: Строка, Маска: Строка): Массив
```
*Глобальный метод* • **Методы**

Находит файлы в указанном каталоге и всех его подкаталогах по маске поиска.

---

## ПолучитьФайлы
```bsl
ПолучитьФайлы(Путь: Строка, Маска: Строка): Массив
```
*Глобальный метод* • **Методы**

Получает список файлов в указанном каталоге по маске.
```

### Структура ответа

Каждый результат содержит:
- **Заголовок** - имя элемента
- **Сигнатура** - синтаксис вызова в формате BSL
- **Тип** - глобальный метод, метод типа, свойство и т.д.
- **Категория** - методы, свойства, типы данных
- **Описание** - краткое описание функциональности

## Архитектура

Сервер построен на Spring Boot с использованием Spring AI MCP Server Boot Starter:

### Основные компоненты

- **McpServerCommand** - CLI команда для запуска
- **McpServerApplication** - Spring Boot приложение
- **PlatformApiSearchService** - бизнес-логика поиска
- **MarkdownFormatterService** - форматирование результатов  
- **McpToolsConfiguration** - регистрация MCP tools

### Слои архитектуры

```
┌─────────────────────────────────────┐
│           Presentation              │
│  ┌─────────────────────────────┐   │
│  │    MCP Tools Interface      │   │
│  │  - search                   │   │
│  │  - info                     │   │
│  │  - getMember                │   │
│  │  - getMembers               │   │
│  │  - getConstructors          │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│            Business                 │
│  ┌─────────────────────────────┐   │
│  │   ContextSearchService      │   │
│  │   ResponseFormatterService  │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         Infrastructure              │
│  ┌─────────────────────────────┐   │
│  │   PlatformContextStorage    │   │
│  │   SearchEngine              │   │
│  │   HBK Parser                │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

### Компоненты поиска

- **SearchEngine** - основной движок поиска
- **SimpleSearchEngine** - базовый поиск по индексам
- **CompoundTypeSearch** - поиск по составным типам
- **TypeMemberSearch** - поиск по элементам типов
- **WordOrderSearch** - поиск с учетом порядка слов
- **RegularSearch** - регулярный поиск

### Индексы

- **HashIndex** - хеш-индекс для точного поиска
- **StartWithIndex** - индекс для префиксного поиска
- **Indexes** - управление всеми индексами

## Производительность

### Оптимизации

- **Индексация при запуске** - все данные индексируются один раз при старте
- **Кэширование результатов** - часто запрашиваемые результаты кэшируются
- **Ленивая загрузка** - данные загружаются по мере необходимости
- **Параллельная обработка** - поиск выполняется в нескольких потоках

### Метрики производительности

- **Время индексации**: ~30-60 секунд (зависит от объема данных)
- **Время поиска**: <100ms для большинства запросов
- **Память**: ~200-500MB (зависит от размера API платформы)
- **Размер индекса**: ~50-100MB

## Логирование

### Уровни логирования

- **INFO** - основная информация о работе сервера
- **DEBUG** - детальная отладочная информация
- **WARN** - предупреждения
- **ERROR** - ошибки

### Файлы логов

- **mcp-server.log** - основной файл логов
- **stderr** - отладочные сообщения (не мешает MCP протоколу)
- **stdout/stdin** - JSON-RPC коммуникация

### Ротация логов

Логи автоматически ротируются:
- Максимальный размер файла: 100MB
- Количество файлов: 10
- Сжатие старых логов: включено

## Безопасность

### Ограничения доступа

- **Только чтение** - сервер не изменяет данные платформы 1С
- **Изоляция** - каждый запрос обрабатывается в изолированном контексте
- **Валидация входных данных** - все параметры проверяются на корректность

### Рекомендации по безопасности

- Используйте Docker с read-only монтированием для платформы 1С
- Ограничьте сетевой доступ для SSE-версии
- Регулярно обновляйте версию сервера
- Мониторьте логи на предмет подозрительной активности